<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Gate Pass Management</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .notifications-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notifications-header h2 {
            margin: 0;
            color: #333;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
        }
        
        .filters-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filters-section select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .filters-section select:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .notifications-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .notification-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4facfe;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .notification-item.unread {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .notification-item.approved {
            border-left-color: #00b894;
        }
        
        .notification-item.rejected {
            border-left-color: #ff4757;
        }
        
        .notification-item.pending {
            border-left-color: #fdcb6e;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .notification-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .notification-time {
            color: #666;
            font-size: 12px;
        }
        
        .notification-message {
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .mark-read-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .mark-read-btn:hover {
            background: #3d8bfd;
        }
        
        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #ff3838;
        }
        
        .notification-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .no-notifications {
            text-align: center;
            color: #999;
            padding: 60px 20px;
            font-style: italic;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .unread-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 10px;
            height: 10px;
            background: #2196f3;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .priority-high {
            border-left-color: #ff4757 !important;
        }
        
        .priority-medium {
            border-left-color: #fdcb6e !important;
        }
        
        .priority-low {
            border-left-color: #00b894 !important;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Navigation Bar -->
        <div class="navbar">
            <h2>Notifications</h2>
            <div>
                <button onclick="goBack()" class="btn btn-secondary">‚Üê Back</button>
                <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px;">Logout</button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number" id="totalNotifications">0</div>
                <div class="stat-label">Total Notifications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadNotifications">0</div>
                <div class="stat-label">Unread Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingRequests">0</div>
                <div class="stat-label">Pending Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="approvedToday">0</div>
                <div class="stat-label">Approved Today</div>
            </div>
        </div>

        <!-- Notifications Header -->
        <div class="notifications-header">
            <div>
                <h2>My Notifications</h2>
                <p>Stay updated with your gate pass requests and system alerts</p>
            </div>
            <div class="notification-actions">
                <button class="btn btn-primary" onclick="markAllAsRead()">Mark All as Read</button>
                <button class="btn btn-danger" onclick="clearAllNotifications()">Clear All</button>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <label for="typeFilter">Filter by Type:</label>
            <select id="typeFilter" onchange="filterNotifications()">
                <option value="all">All Types</option>
                <option value="request">Request Updates</option>
                <option value="approval">Approval Notifications</option>
                <option value="security">Security Alerts</option>
                <option value="system">System Messages</option>
            </select>
            
            <label for="statusFilter">Filter by Status:</label>
            <select id="statusFilter" onchange="filterNotifications()">
                <option value="all">All Status</option>
                <option value="unread">Unread Only</option>
                <option value="read">Read Only</option>
            </select>
            
            <label for="priorityFilter">Filter by Priority:</label>
            <select id="priorityFilter" onchange="filterNotifications()">
                <option value="all">All Priorities</option>
                <option value="high">High Priority</option>
                <option value="medium">Medium Priority</option>
                <option value="low">Low Priority</option>
            </select>
            
            <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
        </div>

        <!-- Notifications List -->
        <div class="notifications-list">
            <h3>Recent Notifications</h3>
            <div id="notificationsList">
                <!-- Notifications will be populated here -->
            </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script>
        // Protect page - redirect to login if not authenticated
        if (!Auth.protectPage()) {
            // Page will redirect automatically
        }

        let notifications = [];

        // Initialize notifications page
        document.addEventListener('DOMContentLoaded', function() {
            const user = Auth.getCurrentUser();
            if (user) {
                initializeNotifications();
                loadNotifications();
                updateStatistics();
            }
        });

        function initializeNotifications() {
            // Initialize notifications if not exists
            if (!localStorage.getItem('notifications')) {
                const user = Auth.getCurrentUser();
                const defaultNotifications = [
                    {
                        id: Auth.generateId(),
                        userId: user.id,
                        type: 'request',
                        title: 'Gate Pass Request Submitted',
                        message: 'Your gate pass request for Medical Emergency has been submitted successfully.',
                        timestamp: new Date().toISOString(),
                        read: false,
                        priority: 'medium',
                        relatedRequestId: 1
                    },
                    {
                        id: Auth.generateId(),
                        userId: user.id,
                        type: 'approval',
                        title: 'Gate Pass Approved',
                        message: 'Your gate pass request for Family Function has been approved by admin.',
                        timestamp: new Date(Date.now() - 3600000).toISOString(),
                        read: false,
                        priority: 'high',
                        relatedRequestId: 2
                    },
                    {
                        id: Auth.generateId(),
                        userId: user.id,
                        type: 'security',
                        title: 'Entry Recorded',
                        message: 'Your entry has been recorded at the main gate.',
                        timestamp: new Date(Date.now() - 7200000).toISOString(),
                        read: true,
                        priority: 'low'
                    },
                    {
                        id: Auth.generateId(),
                        userId: user.id,
                        type: 'system',
                        title: 'System Maintenance',
                        message: 'The gate pass system will undergo maintenance tonight from 11 PM to 1 AM.',
                        timestamp: new Date(Date.now() - 86400000).toISOString(),
                        read: true,
                        priority: 'medium'
                    }
                ];
                localStorage.setItem('notifications', JSON.stringify(defaultNotifications));
            }
        }

        function loadNotifications() {
            const user = Auth.getCurrentUser();
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            // Filter notifications for current user
            notifications = allNotifications.filter(n => n.userId === user.id);
            
            // Sort by timestamp (newest first)
            notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            displayNotifications();
        }

        function displayNotifications() {
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            let filteredNotifications = notifications.filter(notification => {
                let matchType = typeFilter === 'all' || notification.type === typeFilter;
                let matchStatus = statusFilter === 'all' || 
                    (statusFilter === 'unread' && !notification.read) ||
                    (statusFilter === 'read' && notification.read);
                let matchPriority = priorityFilter === 'all' || notification.priority === priorityFilter;
                
                return matchType && matchStatus && matchPriority;
            });
            
            const container = document.getElementById('notificationsList');
            
            if (filteredNotifications.length === 0) {
                container.innerHTML = '<div class="no-notifications">No notifications found for the selected criteria</div>';
                return;
            }
            
            container.innerHTML = filteredNotifications.map(notification => {
                const icon = getNotificationIcon(notification.type);
                const unreadClass = notification.read ? '' : 'unread';
                const priorityClass = `priority-${notification.priority}`;
                const statusClass = notification.type === 'approval' ? 'approved' : 
                                  notification.type === 'request' ? 'pending' : '';
                
                return `
                    <div class="notification-item ${unreadClass} ${priorityClass} ${statusClass}">
                        ${!notification.read ? '<div class="unread-indicator"></div>' : ''}
                        <div class="notification-header">
                            <div>
                                <div class="notification-title">
                                    <span class="notification-icon">${icon}</span>
                                    ${notification.title}
                                </div>
                                <div class="notification-time">
                                    ${formatNotificationTime(notification.timestamp)}
                                </div>
                            </div>
                        </div>
                        <div class="notification-message">
                            ${notification.message}
                        </div>
                        <div class="notification-actions">
                            ${!notification.read ? 
                                `<button class="mark-read-btn" onclick="markAsRead(${notification.id})">Mark as Read</button>` : 
                                '<span style="color: #999; font-size: 12px;">‚úì Read</span>'
                            }
                            <button class="delete-btn" onclick="deleteNotification(${notification.id})">Delete</button>
                            ${notification.relatedRequestId ? 
                                `<button class="btn btn-primary btn-sm" onclick="viewRequest(${notification.relatedRequestId})">View Request</button>` : 
                                ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getNotificationIcon(type) {
            const icons = {
                'request': 'üìù',
                'approval': '‚úÖ',
                'security': 'üîí',
                'system': '‚öôÔ∏è'
            };
            return icons[type] || 'üì¢';
        }

        function formatNotificationTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function markAsRead(notificationId) {
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const notificationIndex = allNotifications.findIndex(n => n.id === notificationId);
            
            if (notificationIndex !== -1) {
                allNotifications[notificationIndex].read = true;
                localStorage.setItem('notifications', JSON.stringify(allNotifications));
                
                loadNotifications();
                updateStatistics();
            }
        }

        function markAllAsRead() {
            const user = Auth.getCurrentUser();
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            allNotifications.forEach(notification => {
                if (notification.userId === user.id) {
                    notification.read = true;
                }
            });
            
            localStorage.setItem('notifications', JSON.stringify(allNotifications));
            
            loadNotifications();
            updateStatistics();
        }

        function deleteNotification(notificationId) {
            if (!confirm('Are you sure you want to delete this notification?')) return;
            
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const filteredNotifications = allNotifications.filter(n => n.id !== notificationId);
            
            localStorage.setItem('notifications', JSON.stringify(filteredNotifications));
            
            loadNotifications();
            updateStatistics();
        }

        function clearAllNotifications() {
            if (!confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) return;
            
            const user = Auth.getCurrentUser();
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const filteredNotifications = allNotifications.filter(n => n.userId !== user.id);
            
            localStorage.setItem('notifications', JSON.stringify(filteredNotifications));
            
            loadNotifications();
            updateStatistics();
        }

        function viewRequest(requestId) {
            // For now, show alert with request details
            const requests = JSON.parse(localStorage.getItem('gatePassRequests') || '[]');
            const request = requests.find(r => r.id === requestId);
            if (request) {
                alert(`Request Details:\n\nID: #${request.id}\nStudent: ${request.name}\nReason: ${request.reason}\nDate: ${request.date}\nTime: ${request.time}\nStatus: ${request.status}`);
            }
        }

        function filterNotifications() {
            displayNotifications();
        }

        function resetFilters() {
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('priorityFilter').value = 'all';
            displayNotifications();
        }

        function updateStatistics() {
            const user = Auth.getCurrentUser();
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const userNotifications = allNotifications.filter(n => n.userId === user.id);
            const unreadNotifications = userNotifications.filter(n => !n.read);
            
            // Count pending requests
            const requests = JSON.parse(localStorage.getItem('gatePassRequests') || '[]');
            const pendingRequests = requests.filter(req => 
                req.userId === user.id && req.status === 'pending'
            );
            
            // Count approved today
            const today = new Date().toISOString().split('T')[0];
            const approvedToday = requests.filter(req => 
                req.userId === user.id && 
                req.status === 'approved' && 
                req.date === today
            );
            
            document.getElementById('totalNotifications').textContent = userNotifications.length;
            document.getElementById('unreadNotifications').textContent = unreadNotifications.length;
            document.getElementById('pendingRequests').textContent = pendingRequests.length;
            document.getElementById('approvedToday').textContent = approvedToday.length;
        }

        function goBack() {
            const user = getCurrentUser();
            if (user.role === 'user') {
                window.location.href = 'user-dashboard.html';
            } else if (user.role === 'admin') {
                window.location.href = 'admin-dashboard.html';
            } else if (user.role === 'security') {
                window.location.href = 'security-dashboard.html';
            }
        }

        // Auto-refresh notifications every 30 seconds
        setInterval(() => {
            loadNotifications();
            updateStatistics();
        }, 30000);
    </script>
</body>
</html>
